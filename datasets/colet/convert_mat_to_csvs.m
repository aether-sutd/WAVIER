% generated by claude sonnet 3.7

% Assuming data_v3 is already loaded in your workspace
% If not, load it first with: load('data_v3.mat');

% Get the variable name of the loaded data
vars = whos;
data_var_name = '';

% Find the variable that is a 1x47 struct array
for i = 1:length(vars)
    if strcmp(vars(i).class, 'struct') && isequal(vars(i).size, [1 47])
        data_var_name = vars(i).name;
        break;
    end
end

% If no variable name was found, prompt user
if isempty(data_var_name)
    data_var_name = input('Enter the variable name of your 1x47 struct array: ', 's');
end

% Get the data using eval
data = eval(data_var_name);

% Create a directory for the CSV files if it doesn't exist
if ~exist('exported_csv', 'dir')
    mkdir('exported_csv');
end

% Loop through each participant
for i = 1:length(data)
    % Check if this participant has the 'task' field
    if isfield(data(i), 'task')
        % Loop through each task
        for j = 1:length(data(i).task)
            % Loop through each data type
            dataTypes = {'gaze', 'pupil', 'annotation', 'blinks'};
            for k = 1:length(dataTypes)
                dataType = dataTypes{k};
                
                % Check if this data type exists for this task
                if isfield(data(i).task(j), dataType)
                    % Get the table
                    tableData = data(i).task(j).(dataType);
                    
                    % Check if it's a table
                    if istable(tableData)
                        % Create the filename
                        filename = sprintf('exported_csv/participant%d_task%d_%s.csv', i, j, dataType);
                        
                        % Write the table to CSV
                        writetable(tableData, filename);
                        fprintf('Exported: %s\n', filename);
                    else
                        fprintf('Warning: Data for participant %d, task %d, %s is not a table.\n', i, j, dataType);
                    end
                else
                    fprintf('Warning: Field %s does not exist for participant %d, task %d.\n', dataType, i, j);
                end
            end
        end
    else
        fprintf('Warning: Participant %d does not have a task field.\n', i);
    end
end

fprintf('Export complete.\n');
